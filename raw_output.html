<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å›½åŸå¸‚å¤©æ°”æŸ¥è¯¢</title>
    <!-- å¼•å…¥Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- å¼•å…¥Chart.jsç”¨äºå¯è§†åŒ– -->
    <!-- ç›´æ¥å¼•å…¥å¤šä¸ªCDNï¼Œç¡®ä¿å…¼å®¹æ€§ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" crossorigin="anonymous" onload="initChartAfterChartJsLoaded()"></script>
    <script src="https://unpkg.com/chart.js@4.4.0/dist/chart.umd.min.js" crossorigin="anonymous" onerror="console.error('Unpkg CDNåŠ è½½å¤±è´¥')" onload="initChartAfterChartJsLoaded()"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js" crossorigin="anonymous" onerror="console.error('Cloudflare CDNåŠ è½½å¤±è´¥')" onload="initChartAfterChartJsLoaded()"></script>
    
    <script>
        // Chart.jsåŠ è½½çŠ¶æ€æ ‡å¿—
        window.chartJsLoaded = typeof Chart !== 'undefined';
        
        // å®šä¹‰å…¨å±€çš„å›¾è¡¨åˆå§‹åŒ–å‡½æ•°
        function initChartAfterChartJsLoaded() {
            console.log('æ£€æŸ¥Chart.jsåŠ è½½çŠ¶æ€:', window.chartJsLoaded, typeof Chart !== 'undefined');
            
            // ä¼˜åŒ–ï¼šåªè¦Chartå¯¹è±¡å¯ç”¨ï¼Œå°±å°è¯•åˆå§‹åŒ–å›¾è¡¨ï¼Œä¸å†ä¸¥æ ¼ä¾èµ–window.chartJsLoadedæ ‡å¿—
            if (typeof Chart !== 'undefined') {
                // Chart.jså·²åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–å›¾è¡¨
                console.log('Chart.jså·²å¯ç”¨ï¼Œå¼€å§‹åˆå§‹åŒ–å›¾è¡¨');
                loadPopularCitiesWeather();
            } else if (window.chartJsLoaded) {
                // æ ‡å¿—è®¾ç½®äº†ä½†Chartå¯¹è±¡ä¸å¯ç”¨ï¼Œå¯èƒ½æ˜¯åŠ è½½é¡ºåºé—®é¢˜
                console.log('Chart.jsæ ‡å¿—å·²è®¾ç½®ä½†å¯¹è±¡ä¸å¯ç”¨ï¼Œå°è¯•åˆå§‹åŒ–å›¾è¡¨');
                loadPopularCitiesWeather();
            } else {
                // ç­‰å¾…Chart.jsåŠ è½½å®Œæˆï¼Œæœ€å¤šç­‰å¾…15ç§’
                let waitTime = 0;
                const interval = setInterval(() => {
                    waitTime += 500;
                    console.log(`ç­‰å¾…Chart.jsåŠ è½½ä¸­...(${waitTime/1000}ç§’)`);
                    
                    if (typeof Chart !== 'undefined' || window.chartJsLoaded) {
                        clearInterval(interval);
                        console.log('Chart.jså·²åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–å›¾è¡¨');
                        loadPopularCitiesWeather();
                    } else if (waitTime >= 15000) {
                        clearInterval(interval);
                        console.error('Chart.jsåŠ è½½è¶…æ—¶ï¼Œä½¿ç”¨é™æ€è¡¨æ ¼');
                        // ç›´æ¥è°ƒç”¨æ˜¾ç¤ºçƒ­é—¨åŸå¸‚å¤©æ°”å‡½æ•°ï¼Œå®ƒä¼šå¤„ç†Chart.jsä¸å¯ç”¨çš„æƒ…å†µ
                        loadPopularCitiesWeather();
                    }
                }, 500);
            }
        }
        </script>
    <!-- å¼•å…¥Font Awesomeå›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* å…¨å±€æ ·å¼ */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-attachment: fixed;
            color: #333;
        }
        
        /* å®¹å™¨æ ·å¼ */
        .container {
            flex: 1;
            padding: 20px 0;
        }
        
        /* å¡ç‰‡æ ·å¼ */
        .weather-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 30px;
            margin-top: 25px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .weather-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
        }
        
        /* å¤´éƒ¨æ ·å¼ */
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 30px 0;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.2);
        }
        
        header h1 {
            font-weight: 800;
            color: #ffffff;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        header p {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 0;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        /* è¡¨å•æ ·å¼ */
        .input-group {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            border-radius: 50px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        
        .form-control {
            border: none;
            font-size: 18px;
            padding: 25px 30px;
            border-radius: 50px 0 0 50px;
            background: transparent;
            color: #2d3748;
        }
        
        .form-control::placeholder {
            color: #a0aec0;
        }
        
        .form-control:focus {
            box-shadow: none;
            outline: none;
            background: transparent;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            font-size: 18px;
            font-weight: 600;
            padding: 0 40px;
            border-radius: 0 50px 50px 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary:hover {
            transform: scale(1.08);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        
        /* å¤©æ°”å›¾æ ‡æ ·å¼ */
        .weather-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: fadeIn 1s ease;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.15));
            transition: color 0.3s ease;
        }
        
        /* å¤©æ°”å›¾æ ‡é¢œè‰² */
        .weather-icon.sunny {
            color: #ffd700;
        }
        
        .weather-icon.cloudy {
            color: #a0aec0;
        }
        
        .weather-icon.rainy {
            color: #4facfe;
        }
        
        .weather-icon.snowy {
            color: #e2e8f0;
        }
        
        .weather-icon.thunderstorm {
            color: #667eea;
        }
        
        /* æ¸©åº¦æ ·å¼ */
        .temperature {
            font-size: 64px;
            font-weight: 800;
            color: #2d3748;
            margin: 15px 0;
            animation: fadeIn 1s ease 0.2s both;
            text-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* å¤©æ°”çŠ¶å†µæ ·å¼ */
        #weatherCondition {
            font-size: 24px;
            color: #4a5568;
            font-weight: 600;
            animation: fadeIn 1s ease 0.4s both;
            text-transform: capitalize;
        }
        
        /* å¤©æ°”ä¿¡æ¯æ ·å¼ */
        #windInfo, #humidity, #pressure, #visibility, #aqi {
            font-size: 18px;
            color: #718096;
            margin: 12px 0;
            animation: fadeIn 1s ease 0.6s both;
            font-weight: 500;
        }
        
        /* å¤©æ°”ä¿¡æ¯å›¾æ ‡ */
        #windInfo i, #humidity i, #pressure i, #visibility i, #aqi i {
            color: #4facfe;
            margin-right: 8px;
            font-size: 20px;
        }
        
        /* ç»“æœæ ‡é¢˜æ ·å¼ */
        #resultCity {
            font-size: 36px;
            font-weight: 800;
            color: #2d3748;
            margin-bottom: 25px;
            animation: fadeIn 1s ease;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* é”™è¯¯æç¤ºæ ·å¼ */
        .alert {
            margin-top: 25px;
            display: none;
            border-radius: 15px;
            animation: slideInDown 0.5s ease;
            border: none;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            padding: 20px;
            font-size: 16px;
        }
        
        /* å›¾è¡¨å®¹å™¨æ ·å¼ */
        #chartContainer {
            margin-top: 40px;
            height: 400px;
            animation: fadeIn 1s ease;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }
        
        /* é¡µè„šæ ·å¼ */
        footer {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 60px;
            padding: 30px 0;
            box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.1);
        }
        
        footer p {
            color: #718096;
            font-size: 14px;
            margin-bottom: 0;
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* å¤©æ°”å¡ç‰‡åˆ†éš”çº¿ */
        .weather-card hr {
            border-color: rgba(0, 0, 0, 0.05);
            margin: 30px 0;
        }
        
        /* çƒ­é—¨åŸå¸‚æ ‡ç­¾ */
        .popular-cities {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .popular-city-tag {
            background: rgba(79, 172, 254, 0.1);
            color: #4facfe;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            border: 1px solid rgba(79, 172, 254, 0.2);
        }
        
        .popular-city-tag:hover {
            background: rgba(79, 172, 254, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .spinner-border {
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }
        
        /* å›¾è¡¨æ ‡é¢˜ */
        #chartContainer h3 {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .weather-card {
                padding: 25px;
                margin-top: 20px;
            }
            
            #resultCity {
                font-size: 28px;
            }
            
            .temperature {
                font-size: 48px;
            }
            
            .weather-icon {
                font-size: 64px;
            }
            
            header h1 {
                font-size: 2rem;
            }
            
            header p {
                font-size: 1rem;
            }
            
            .form-control {
                font-size: 16px;
                padding: 20px 25px;
            }
            
            .btn-primary {
                font-size: 16px;
                padding: 0 30px;
            }
            
            #chartContainer {
                height: 350px;
                padding: 20px;
            }
        }
        
        /* å¤©æ°”ä¿¡æ¯å¡ç‰‡ */
        .weather-info-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .weather-info-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
    </style>
</head>
<body>
    <header class="bg-primary text-white text-center py-5">
        <div class="container text-center">
            <h1>ä¸­å›½åŸå¸‚å¤©æ°”æŸ¥è¯¢</h1>
            <p>è¾“å…¥ä»»æ„åŸå¸‚åç§°ï¼ŒæŸ¥è¯¢å®æ—¶å¤©æ°”ä¿¡æ¯</p>
        </div>
    </header>

    <div class="container">
        <!-- ç½‘ç«™è¿è¡ŒçŠ¶æ€æ˜¾ç¤º -->
        <div class="alert alert-success text-center" style="margin-top: 20px;">
            <i class="fas fa-check-circle me-2"></i> ç½‘ç«™è¿è¡Œæ­£å¸¸
        </div>
        
        <div class="row justify-content-center">
            <div class="col-md-8">
                <!-- æŸ¥è¯¢è¡¨å• -->
                <div class="weather-card">
                    <div class="input-group mb-4">
                        <input type="text" id="cityInput" class="form-control" placeholder="è¯·è¾“å…¥åŸå¸‚åç§°ï¼Œå¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€å¹¿å·" aria-label="åŸå¸‚åç§°" aria-describedby="searchBtn" autocomplete="off">
                        <button class="btn btn-primary" type="button" id="searchBtn">æŸ¥è¯¢å¤©æ°”</button>
                    </div>
                    
                    <!-- åŸå¸‚è¾“å…¥è‡ªåŠ¨å®Œæˆä¸‹æ‹‰æ¡† -->
                    <div id="citySuggestions" class="list-group mb-4" style="display: none; position: absolute; width: calc(100% - 60px); z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                    
                    <!-- çƒ­é—¨åŸå¸‚æ ‡ç­¾ -->
                    <div class="popular-cities mb-3">
                        <span class="text-muted me-2">çƒ­é—¨åŸå¸‚ï¼š</span>
                        <span class="popular-city-tag" onclick="selectCity('åŒ—äº¬')">åŒ—äº¬</span>
                        <span class="popular-city-tag" onclick="selectCity('ä¸Šæµ·')">ä¸Šæµ·</span>
                        <span class="popular-city-tag" onclick="selectCity('å¹¿å·')">å¹¿å·</span>
                        <span class="popular-city-tag" onclick="selectCity('æ·±åœ³')">æ·±åœ³</span>
                        <span class="popular-city-tag" onclick="selectCity('æ­å·')">æ­å·</span>
                        <span class="popular-city-tag" onclick="selectCity('æˆéƒ½')">æˆéƒ½</span>
                        <span class="popular-city-tag" onclick="selectCity('æ­¦æ±‰')">æ­¦æ±‰</span>
                        <span class="popular-city-tag" onclick="selectCity('è¥¿å®‰')">è¥¿å®‰</span>
                        <span class="popular-city-tag" onclick="selectCity('é‡åº†')">é‡åº†</span>
                        <span class="popular-city-tag" onclick="selectCity('å—äº¬')">å—äº¬</span>
                        <span class="popular-city-tag" onclick="selectCity('å¤©æ´¥')">å¤©æ´¥</span>
                        <span class="popular-city-tag" onclick="selectCity('è‹å·')">è‹å·</span>
                        <span class="popular-city-tag" onclick="selectCity('éƒ‘å·')">éƒ‘å·</span>
                        <span class="popular-city-tag" onclick="selectCity('é•¿æ²™')">é•¿æ²™</span>
                        <span class="popular-city-tag" onclick="selectCity('æ²ˆé˜³')">æ²ˆé˜³</span>
                    </div>
                </div>

                <!-- é”™è¯¯æç¤º -->
                <div id="errorAlert" class="alert alert-danger" role="alert">
                    <strong>é”™è¯¯ï¼š</strong><span id="errorMessage"></span>
                </div>

                <!-- å¤©æ°”ç»“æœå±•ç¤º -->
                <div id="weatherResult" class="weather-card" style="display: none;">
                    <h2 id="resultCity" class="text-center mb-4"></h2>
                    
                    <!-- æ¸©åº¦æç¤º -->
                    <div id="temperatureAlert" class="alert" role="alert">
                        <strong id="alertTitle">æ¸©é¦¨æç¤ºï¼š</strong><span id="alertMessage"></span>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <div id="weatherIcon" class="weather-icon"></div>
                            <div id="weatherCondition"></div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div id="temperature" class="temperature"></div>
                            <div id="windInfo"></div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div id="humidity"></div>
                            <div id="pressure"></div>
                            <div id="visibility"></div>
                            <div id="aqi"></div>
                        </div>
                    </div>
                </div>

                <!-- å†å²å¤©æ°”æŸ¥è¯¢ -->
                <div id="historicalContainer" class="weather-card">
                    <h3 class="text-center mb-4">å†å²å¤©æ°”æŸ¥è¯¢</h3>
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="input-group mb-3">
                                <input type="text" id="historicalCity" class="form-control" placeholder="è¯·è¾“å…¥åŸå¸‚åç§°" aria-label="åŸå¸‚åç§°">
                                <input type="date" id="historicalDate" class="form-control" aria-label="æŸ¥è¯¢æ—¥æœŸ">
                                <button class="btn btn-primary" type="button" id="historicalSearch">æŸ¥è¯¢å†å²</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å†å²æŸ¥è¯¢ç»“æœ -->
                    <div id="historicalResult" class="mt-4" style="display: none;">
                        <h4 id="historicalCityResult" class="text-center mb-3"></h4>
                        <div id="historicalDataTable"></div>
                    </div>
                </div>

                <!-- å¯è§†åŒ–å›¾è¡¨ -->
                <div id="chartContainer" class="weather-card" style="display: block; height: 500px;">
                    <h3 class="text-center mb-4">çƒ­é—¨åŸå¸‚æ¸©åº¦å¯¹æ¯”</h3>
                    <canvas id="temperatureChart" width="800" height="400"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // çƒ­é—¨åŸå¸‚åˆ—è¡¨ï¼ˆä¸åç«¯åŸå¸‚åæ ‡æ˜ å°„è¡¨ä¿æŒä¸€è‡´ï¼‰
        const popularCities = ['åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³', 'æ­å·', 'æˆéƒ½', 'æ­¦æ±‰', 'è¥¿å®‰', 'é‡åº†', 'å—äº¬', 'å¤©æ´¥', 'æ˜†æ˜', 'å‘¼å’Œæµ©ç‰¹', 'æ‹‰è¨', 'ä¹Œé²æœ¨é½', 'é“¶å·', 'è¥¿å®', 'å—å®', 'æµå—', 'çŸ³å®¶åº„', 'å“ˆå°”æ»¨', 'é•¿æ˜¥', 'æ²ˆé˜³', 'éƒ‘å·', 'åˆè‚¥', 'ç¦å·', 'å—æ˜Œ', 'é•¿æ²™', 'è´µé˜³', 'æµ·å£', 'å…°å·'];

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç»‘å®šæŸ¥è¯¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('searchBtn').addEventListener('click', searchWeather);
            
            // ç»‘å®šå›è½¦é”®äº‹ä»¶
            document.getElementById('cityInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchWeather();
                }
            });
            
            // åŸå¸‚è¾“å…¥è‡ªåŠ¨å®ŒæˆåŠŸèƒ½
            const cityInput = document.getElementById('cityInput');
            const citySuggestions = document.getElementById('citySuggestions');
            
            // æ‰€æœ‰æ”¯æŒçš„åŸå¸‚åˆ—è¡¨
            const allCities = [
                'åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³', 'æ­å·', 'æˆéƒ½', 'æ­¦æ±‰', 'è¥¿å®‰', 'é‡åº†', 'å—äº¬',
                'å¤©æ´¥', 'è‹å·', 'éƒ‘å·', 'é•¿æ²™', 'æ²ˆé˜³', 'é’å²›', 'æµå—', 'å¤§è¿', 'å®æ³¢', 'å¦é—¨',
                'ç¦å·', 'å“ˆå°”æ»¨', 'é•¿æ˜¥', 'çŸ³å®¶åº„', 'å¤ªåŸ', 'åˆè‚¥', 'å—æ˜Œ', 'å—å®', 'è´µé˜³', 'æ˜†æ˜',
                'æ‹‰è¨', 'å…°å·', 'è¥¿å®', 'é“¶å·', 'ä¹Œé²æœ¨é½', 'å‘¼å’Œæµ©ç‰¹', 'æ‹‰è¨', 'æ¾³é—¨', 'é¦™æ¸¯', 'å°æ¹¾'
            ];
            
            // è¾“å…¥äº‹ä»¶ç›‘å¬
            cityInput.addEventListener('input', function() {
                const input = this.value.trim().toLowerCase();
                citySuggestions.innerHTML = '';
                
                if (input.length > 0) {
                    // è¿‡æ»¤åŒ¹é…çš„åŸå¸‚
                    const matches = allCities.filter(city => 
                        city.toLowerCase().includes(input)
                    );
                    
                    // æ˜¾ç¤ºå»ºè®®
                    if (matches.length > 0) {
                        citySuggestions.style.display = 'block';
                        matches.forEach(city => {
                            const item = document.createElement('button');
                            item.type = 'button';
                            item.className = 'list-group-item list-group-item-action';
                            item.textContent = city;
                            item.addEventListener('click', function() {
                                selectCity(city);
                                citySuggestions.style.display = 'none';
                            });
                            citySuggestions.appendChild(item);
                        });
                    } else {
                        citySuggestions.style.display = 'none';
                    }
                } else {
                    citySuggestions.style.display = 'none';
                }
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­å»ºè®®
            document.addEventListener('click', function(e) {
                if (!cityInput.contains(e.target) && !citySuggestions.contains(e.target)) {
                    citySuggestions.style.display = 'none';
                }
            });

            // ç½‘ç«™è¿è¡ŒçŠ¶æ€æ˜¾ç¤ºå·²ç»åœ¨HTMLä¸­é™æ€æ·»åŠ 
            
            // ç»‘å®šå†å²å¤©æ°”æŸ¥è¯¢æŒ‰é’®
            document.getElementById('historicalSearch').addEventListener('click', searchHistoricalWeather);
            
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºæ˜¨å¤©
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            document.getElementById('historicalDate').value = yesterdayStr;
            
            // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ˜¾ç¤ºçƒ­é—¨åŸå¸‚æ¸©åº¦å¯¹æ¯”å›¾è¡¨
            // ä½†è¦ç¡®ä¿Chart.jså®Œå…¨åŠ è½½åå†æ‰§è¡Œ
            
            // DOMå·²ç»åŠ è½½å®Œæˆï¼Œç›´æ¥æ£€æŸ¥Chart.jsçŠ¶æ€
            
            // é¡µé¢åŠ è½½å®Œæˆåç«‹å³æ£€æŸ¥Chart.jsçŠ¶æ€å¹¶åˆå§‹åŒ–å›¾è¡¨
            initChartAfterChartJsLoaded();
            
            // æ˜¾ç¤ºçƒ­é—¨åŸå¸‚åˆ—è¡¨çš„å‡½æ•°
            function showPopularCitiesList() {
                console.log('æ˜¾ç¤ºçƒ­é—¨åŸå¸‚åˆ—è¡¨');
                const chartContainer = document.getElementById('chartContainer');
                if (chartContainer) {
                    chartContainer.innerHTML = `
                        <h3 class="text-center mb-4">çƒ­é—¨åŸå¸‚æ¸©åº¦å®æ—¶å¯¹æ¯”</h3>
                        <div class="alert alert-warning text-center">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            å›¾è¡¨åŠ è½½å¤±è´¥ï¼Œæ­£åœ¨ä½¿ç”¨é™æ€æ•°æ®å±•ç¤º
                        </div>
                        <div class="text-center">
                            <p>çƒ­é—¨åŸå¸‚ï¼š${popularCities.slice(0, 10).join('ã€')}</p>
                            <button class="btn btn-primary" onclick="loadPopularCitiesWeather()">
                                <i class="fas fa-refresh me-2"></i>é‡è¯•åŠ è½½å›¾è¡¨
                            </button>
                        </div>
                    `;
                }
            }
        });
        
        // é€‰æ‹©çƒ­é—¨åŸå¸‚å‡½æ•°
        function selectCity(cityName) {
            document.getElementById('cityInput').value = cityName;
            searchWeather();
        }

        // æŸ¥è¯¢å¤©æ°”å‡½æ•°
        function searchWeather() {
            const city = document.getElementById('cityInput').value.trim();
            
            if (!city) {
                showError('è¯·è¾“å…¥åŸå¸‚åç§°');
                return;
            }

            // éšè—ä¹‹å‰çš„ç»“æœå’Œé”™è¯¯
            hideError();
            hideWeatherResult();
            
            // éšè—åŸå¸‚å»ºè®®
            document.getElementById('citySuggestions').style.display = 'none';

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading();

            // å‘é€APIè¯·æ±‚ï¼ˆæ·»åŠ è¶…æ—¶å¤„ç†ï¼‰
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ—¶

            fetch(`/weather?city=${encodeURIComponent(city)}`, {
                signal: controller.signal
            })
                .then(response => {
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.error || `HTTPé”™è¯¯: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                    } else {
                        displayWeatherResult(data);
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        showError('ç½‘ç»œè¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
                    } else if (!navigator.onLine) {
                        showError('å½“å‰ç½‘ç»œä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
                    } else {
                        showError(`æŸ¥è¯¢å¤±è´¥: ${error.message}`);
                    }
                    console.error('Error:', error);
                })
                .finally(() => {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    hideLoading();
                });
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = message;
            errorAlert.style.display = 'block';
            
            // æ ¹æ®é”™è¯¯ç±»å‹è®¾ç½®ä¸åŒçš„æ ·å¼
            if (message.includes('ç½‘ç»œ') || message.includes('è¶…æ—¶')) {
                errorAlert.className = 'alert alert-warning';
            } else {
                errorAlert.className = 'alert alert-danger';
            }
            
            // æ·»åŠ è‡ªåŠ¨éšè—åŠŸèƒ½
            setTimeout(() => {
                hideError();
            }, 5000);
        }

        // éšè—é”™è¯¯ä¿¡æ¯
        function hideError() {
            const errorAlert = document.getElementById('errorAlert');
            errorAlert.style.display = 'none';
        }
        
        // æ˜¾ç¤ºç½‘ç»œçŠ¶æ€æç¤º
        function checkNetworkStatus() {
            if (!navigator.onLine) {
                showError('å½“å‰ç½‘ç»œä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
                return false;
            }
            return true;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('searchBtn').disabled = true;
            document.getElementById('searchBtn').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> æŸ¥è¯¢ä¸­...';
        }
        
        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            document.getElementById('searchBtn').disabled = false;
            document.getElementById('searchBtn').textContent = 'æŸ¥è¯¢å¤©æ°”';
        }

        // æ˜¾ç¤ºå¤©æ°”ç»“æœ
        function displayWeatherResult(data) {
            document.getElementById('resultCity').textContent = data.city;
            document.getElementById('temperature').textContent = data.temperature;
            document.getElementById('weatherCondition').textContent = data.weather;
            document.getElementById('windInfo').textContent = `é£åŠ›ï¼š${data.wind} ${data.wind_dir}`;
            document.getElementById('humidity').textContent = `æ¹¿åº¦ï¼š${data.humidity}`;
            document.getElementById('pressure').textContent = `æ°”å‹ï¼š${data.pressure}`;
            document.getElementById('visibility').textContent = `èƒ½è§åº¦ï¼š${data.visibility}`;
            document.getElementById('aqi').textContent = `ç©ºæ°”è´¨é‡æŒ‡æ•°ï¼š${data.aqi}`;

            // æ ¹æ®å¤©æ°”çŠ¶å†µè®¾ç½®å›¾æ ‡
            setWeatherIcon(data.weather);

            // æ£€æŸ¥æ¸©åº¦å¹¶æ˜¾ç¤ºé¢„è­¦
            checkTemperatureAlert(data.temperature);

            // æ˜¾ç¤ºç»“æœ
            document.getElementById('weatherResult').style.display = 'block';
        }

        // æ£€æŸ¥æ¸©åº¦å¹¶æ˜¾ç¤ºé¢„è­¦
        function checkTemperatureAlert(temperatureStr) {
            const temp = parseFloat(temperatureStr.replace('Â°C', ''));
            const alertDiv = document.getElementById('temperatureAlert');
            const alertTitle = document.getElementById('alertTitle');
            const alertMessage = document.getElementById('alertMessage');
            
            // é»˜è®¤éšè—é¢„è­¦
            alertDiv.style.display = 'none';
            
            if (temp >= 35) {
                // é«˜æ¸©é¢„è­¦
                alertDiv.className = 'alert alert-danger';
                alertTitle.textContent = 'é«˜æ¸©é¢„è­¦ï¼š';
                alertMessage.innerHTML = `æ°”æ¸©å¾ˆé«˜ï¼ˆ${temp}Â°Cï¼‰ï¼Œè¯·æ³¨æ„é˜²æš‘é™æ¸©ï¼Œé¿å…é•¿æ—¶é—´æˆ·å¤–æ´»åŠ¨ï¼Œé˜²æ­¢ä¸­æš‘ï¼<br><br>ğŸ’§ å¥åº·å»ºè®®ï¼š<br>- å¤šå–æ°´ï¼Œä¿æŒèº«ä½“æ°´åˆ†<br>- é¿å…æ­£åˆæ—¶åˆ†å¤–å‡º<br>- ç©¿ç€å®½æ¾é€æ°”çš„è¡£ç‰©<br>- æ³¨æ„é¥®é£Ÿæ¸…æ·¡`;
                alertDiv.style.display = 'block';
            } else if (temp >= 25) {
                // è¾ƒçƒ­é¢„è­¦
                alertDiv.className = 'alert alert-warning';
                alertTitle.textContent = 'é«˜æ¸©æç¤ºï¼š';
                alertMessage.innerHTML = `æ°”æ¸©è¾ƒé«˜ï¼ˆ${temp}Â°Cï¼‰ï¼Œè¯·æ³¨æ„é˜²æš‘ï¼Œå¤šå–æ°´ï¼Œé¿å…æš´æ™’<br><br>ğŸŒ¤ï¸ å¥åº·å»ºè®®ï¼š<br>- å‡ºé—¨æ¶‚æŠ¹é˜²æ™’éœœ<br>- ä½©æˆ´é®é˜³å¸½å’Œå¤ªé˜³é•œ<br>- é€‚å½“è¡¥å……ç›åˆ†`;
                alertDiv.style.display = 'block';
            } else if (temp >= 15) {
                // èˆ’é€‚æ¸©åº¦
                alertDiv.className = 'alert alert-success';
                alertTitle.textContent = 'æ¸©é¦¨æç¤ºï¼š';
                alertMessage.innerHTML = `æ°”æ¸©é€‚å®œï¼ˆ${temp}Â°Cï¼‰ï¼Œé€‚åˆè¿›è¡Œæˆ·å¤–æ´»åŠ¨<br><br>ğŸ˜Š å¥åº·å»ºè®®ï¼š<br>- å¤šè¿›è¡Œæˆ·å¤–è¿åŠ¨<br>- ä¿æŒè‰¯å¥½çš„ä½œæ¯æ—¶é—´<br>- æ³¨æ„é¥®é£Ÿå‡è¡¡`;
                alertDiv.style.display = 'block';
            } else if (temp >= 10) {
                // è¾ƒå‡‰é¢„è­¦
                alertDiv.className = 'alert alert-info';
                alertTitle.textContent = 'æ¸©é¦¨æç¤ºï¼š';
                alertMessage.innerHTML = `æ°”æ¸©è¾ƒä½ï¼ˆ${temp}Â°Cï¼‰ï¼Œè¯·æ³¨æ„å¢å‡è¡£ç‰©ï¼Œé¢„é˜²æ„Ÿå†’<br><br>ğŸ§¥ å¥åº·å»ºè®®ï¼š<br>- æ—©æ™šé€‚å½“å¢æ·»è¡£ç‰©<br>- æ³¨æ„å®¤å†…é€šé£<br>- å¤šå–æ¸©æ°´`;
                alertDiv.style.display = 'block';
            } else if (temp >= 0) {
                // ä½æ¸©è­¦å‘Š
                alertDiv.className = 'alert alert-warning';
                alertTitle.textContent = 'ä½æ¸©è­¦å‘Šï¼š';
                alertMessage.innerHTML = `æ°”æ¸©å¾ˆä½ï¼ˆ${temp}Â°Cï¼‰ï¼Œè¯·æ³¨æ„ä¿æš–ï¼Œå»ºè®®ç©¿ç€åšå¤–å¥—å’Œæ¯›è¡£<br><br>â„ï¸ å¥åº·å»ºè®®ï¼š<br>- ç©¿ç€ä¿æš–çš„è¡£ç‰©ï¼ˆå¸½å­ã€å›´å·¾ã€æ‰‹å¥—ï¼‰<br>- æ³¨æ„è„šéƒ¨ä¿æš–<br>- é€‚å½“å¢åŠ çƒ­é‡æ‘„å…¥`;
                alertDiv.style.display = 'block';
            } else if (temp >= -5) {
                // ä¸¥å¯’è­¦å‘Š
                alertDiv.className = 'alert alert-danger';
                alertTitle.textContent = 'ä¸¥å¯’è­¦å‘Šï¼š';
                alertMessage.innerHTML = `æ°”æ¸©æä½ï¼ˆ${temp}Â°Cï¼‰ï¼Œè¯·åšå¥½é˜²å¯’ä¿æš–æªæ–½ï¼Œå»ºè®®ç©¿ç€ç¾½ç»’æœ<br><br>âš ï¸ å¥åº·å»ºè®®ï¼š<br>- å‡å°‘æˆ·å¤–æ´»åŠ¨æ—¶é—´<br>- æ³¨æ„ä¿æŠ¤æ‰‹è„šå’Œé¢éƒ¨<br>- é¿å…é•¿æ—¶é—´æš´éœ²åœ¨ä½æ¸©ç¯å¢ƒ`;
                alertDiv.style.display = 'block';
            } else {
                // æç«¯ä¸¥å¯’
                alertDiv.className = 'alert alert-danger';
                alertTitle.textContent = 'æç«¯ä¸¥å¯’è­¦å‘Šï¼š';
                alertMessage.innerHTML = `æ°”æ¸©æä½ï¼ˆ${temp}Â°Cï¼‰ï¼Œè¯·é¿å…é•¿æ—¶é—´æˆ·å¤–æ´»åŠ¨ï¼Œæ³¨æ„é˜²å†»ä¼¤ï¼<br><br>ğŸš¨ å¥åº·å»ºè®®ï¼š<br>- å°½é‡å¾…åœ¨å®¤å†…<br>- ä½¿ç”¨å–æš–è®¾å¤‡æ—¶æ³¨æ„å®‰å…¨<br>- å¦‚å¿…é¡»å¤–å‡ºï¼Œåšå¥½å…¨é¢é˜²å¯’æªæ–½<br>- æ³¨æ„é¢„é˜²å†»ç–®å’Œä½ä½“æ¸©ç—‡`;
                alertDiv.style.display = 'block';
            }
        }

        // éšè—å¤©æ°”ç»“æœ
        function hideWeatherResult() {
            document.getElementById('weatherResult').style.display = 'none';
        }

        // è®¾ç½®å¤©æ°”å›¾æ ‡
        function setWeatherIcon(weatherCondition) {
            const iconElement = document.getElementById('weatherIcon');
            let icon = 'â˜€ï¸'; // é»˜è®¤æ™´å¤©
            let iconClass = 'sunny';

            if (weatherCondition.includes('æ™´')) {
                icon = 'â˜€ï¸';
                iconClass = 'sunny';
            } else if (weatherCondition.includes('äº‘') || weatherCondition.includes('é˜´')) {
                icon = 'â˜ï¸';
                iconClass = 'cloudy';
            } else if (weatherCondition.includes('é›¨')) {
                icon = 'ğŸŒ§ï¸';
                iconClass = 'rainy';
            } else if (weatherCondition.includes('é›ª')) {
                icon = 'â„ï¸';
                iconClass = 'snowy';
            } else if (weatherCondition.includes('é›¾')) {
                icon = 'ğŸŒ«ï¸';
                iconClass = 'cloudy';
            } else if (weatherCondition.includes('é›·')) {
                icon = 'â›ˆï¸';
                iconClass = 'thunderstorm';
            }

            // ç§»é™¤æ‰€æœ‰å¤©æ°”å›¾æ ‡ç±»ï¼Œæ·»åŠ å½“å‰å¤©æ°”å›¾æ ‡ç±»
            iconElement.className = 'weather-icon';
            iconElement.classList.add(iconClass);
            iconElement.textContent = icon;
        }

        // åŠ è½½çƒ­é—¨åŸå¸‚å¤©æ°”æ•°æ®å¹¶ç»˜åˆ¶å›¾è¡¨
        function loadPopularCitiesWeather(callback) {
            console.log('å¼€å§‹åŠ è½½çƒ­é—¨åŸå¸‚å¤©æ°”æ•°æ®');
            // åªé€‰æ‹©å‰10ä¸ªçƒ­é—¨åŸå¸‚ï¼Œé¿å…è¿‡å¤šAPIè¯·æ±‚
            const selectedCities = popularCities.slice(0, 10);
            const temperatures = [];
            let completedRequests = 0;
            let failedRequests = 0;

            // åˆå§‹åŒ–æ¸©åº¦æ•°ç»„
            selectedCities.forEach(() => {
                temperatures.push(null);
            });

            console.log('é€‰æ‹©çš„çƒ­é—¨åŸå¸‚åˆ—è¡¨:', selectedCities);
            console.log('Chart.jsæ˜¯å¦å¯ç”¨:', typeof Chart !== 'undefined');
            console.log('Chart.jsç‰ˆæœ¬:', Chart ? Chart.version : 'æœªåŠ è½½');
            console.log('å›¾è¡¨å®¹å™¨æ˜¯å¦å­˜åœ¨:', document.getElementById('chartContainer'));
            console.log('Canvaså…ƒç´ æ˜¯å¦å­˜åœ¨:', document.getElementById('temperatureChart'));

            // æ‰¹é‡è¯·æ±‚çƒ­é—¨åŸå¸‚å¤©æ°”æ•°æ®ï¼ˆæ·»åŠ è¶…æ—¶å’Œé‡è¯•æœºåˆ¶ï¼‰
            const batchRequest = (city, index, retryCount = 0) => {
                // ä½¿ç”¨å…¼å®¹çš„è¶…æ—¶æœºåˆ¶
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);
                
                fetch(`/weather?city=${encodeURIComponent(city)}`, {
                    signal: controller.signal
                })
                .then(response => {
                    clearTimeout(timeoutId);
                    return response.json();
                })
                .then(data => {
                    completedRequests++;
                    if (!data.error && data.temperature) {
                        // æå–æ¸©åº¦æ•°å€¼
                        const tempStr = data.temperature;
                        const temp = parseFloat(tempStr.replace('Â°C', ''));
                        temperatures[index] = temp;
                        console.log(`è·å–${city}å¤©æ°”æˆåŠŸï¼Œæ¸©åº¦ï¼š${temp}Â°C`);
                    } else {
                        temperatures[index] = 0;
                        failedRequests++;
                        console.error(`è·å–${city}å¤©æ°”å¤±è´¥:`, data.error || 'æ— æ¸©åº¦æ•°æ®');
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰è¯·æ±‚éƒ½å®Œæˆ
                    checkAllRequestsComplete();
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    completedRequests++;
                    failedRequests++;
                    temperatures[index] = 0;
                    console.error(`è·å–${city}å¤©æ°”å¤±è´¥:`, error);
                    
                    // é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤šé‡è¯•2æ¬¡ï¼‰
                    if (retryCount < 2) {
                        console.log(`é‡è¯•è·å–${city}å¤©æ°”ï¼Œç¬¬${retryCount + 1}æ¬¡`);
                        // å»¶è¿Ÿé‡è¯•ï¼Œé¿å…ç¬é—´å¤§é‡è¯·æ±‚
                        setTimeout(() => batchRequest(city, index, retryCount + 1), 1000);
                        return;
                    }
                    
                    // é‡è¯•å¤±è´¥åä¹Ÿè¦æ£€æŸ¥æ˜¯å¦æ‰€æœ‰è¯·æ±‚éƒ½å®Œæˆ
                    checkAllRequestsComplete();
                });
            };

            // æ£€æŸ¥æ‰€æœ‰è¯·æ±‚æ˜¯å¦å®Œæˆ
            function checkAllRequestsComplete() {
                if (completedRequests === selectedCities.length) {
                    console.log('æ‰€æœ‰è¯·æ±‚å®Œæˆï¼ŒæˆåŠŸ:', completedRequests - failedRequests, 'å¤±è´¥:', failedRequests);
                    console.log('æœ€ç»ˆæ¸©åº¦æ•°æ®:', temperatures);
                    
                    // ç¡®ä¿æ•°æ®æœ‰æ•ˆåå†ç»˜åˆ¶å›¾è¡¨
                    const hasValidData = temperatures.some(temp => temp !== null && temp !== 0);
                    if (!hasValidData) {
                        console.error('æ²¡æœ‰æœ‰æ•ˆçš„æ¸©åº¦æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æµ‹è¯•æ•°æ®');
                        // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæµ‹è¯•
                        const mockTemperatures = [15, 18, 22, 25, 19, 21, 16, 23, 20, 17];
                        drawTemperatureChart(selectedCities, mockTemperatures);
                    } else {
                        drawTemperatureChart(selectedCities, temperatures);
                    }
                    
                    document.getElementById('chartContainer').style.display = 'block';
                    // è°ƒç”¨å›è°ƒå‡½æ•°
                    if (callback && typeof callback === 'function') {
                        callback();
                    }
                }
            }

            // æŒ‰é¡ºåºå‘èµ·è¯·æ±‚ï¼Œæ¯æ¬¡é—´éš”500msï¼Œé¿å…å¹¶å‘è¯·æ±‚è¿‡å¤š
            selectedCities.forEach((city, index) => {
                setTimeout(() => batchRequest(city, index), index * 500);
            });
        }

        // ç»˜åˆ¶æ¸©åº¦å¯¹æ¯”å›¾è¡¨ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼Œç¡®ä¿èƒ½æ­£å¸¸æ˜¾ç¤ºï¼‰
        function drawTemperatureChart(cities, temperatures) {
            console.log('å¼€å§‹ç»˜åˆ¶æ¸©åº¦å¯¹æ¯”å›¾è¡¨');
            console.log('Chartå¯¹è±¡æ˜¯å¦å­˜åœ¨:', typeof Chart !== 'undefined');
            console.log('åŸå¸‚æ•°æ®:', cities);
            console.log('æ¸©åº¦æ•°æ®:', temperatures);
            
            // ç¡®ä¿å›¾è¡¨å®¹å™¨å’Œcanvaså…ƒç´ å­˜åœ¨
            const chartContainer = document.getElementById('chartContainer');
            let canvas = document.getElementById('temperatureChart');
            
            if (!chartContainer || !canvas) {
                console.error('å›¾è¡¨å®¹å™¨æˆ–canvaså…ƒç´ ä¸å­˜åœ¨');
                showStaticTemperatureTable(cities, temperatures);
                return;
            }
            
            // å¼ºåˆ¶æ˜¾ç¤ºå›¾è¡¨å®¹å™¨å¹¶è®¾ç½®å°ºå¯¸
            chartContainer.style.display = 'block';
            chartContainer.style.height = '500px';
            
            // å…ˆæ¸…é™¤ä¹‹å‰çš„è¡¨æ ¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const existingTable = chartContainer.querySelector('#temperatureTable');
            if (existingTable) {
                existingTable.remove();
            }
            
            // ç¡®ä¿canvaså¯è§å¹¶é‡ç½®å°ºå¯¸
            canvas.style.display = 'block';
            canvas.style.width = '100%';
            canvas.style.height = '450px'; // æ˜¾å¼è®¾ç½®é«˜åº¦
            
            // é‡æ–°è®¾ç½®canvaså®é™…å°ºå¯¸ä»¥é€‚åº”å®¹å™¨
            const rect = chartContainer.getBoundingClientRect();
            console.log('å›¾è¡¨å®¹å™¨å°ºå¯¸:', rect.width, 'x', rect.height);
            canvas.width = rect.width - 50; // å‡å»padding
            canvas.height = 450;
            console.log('Canvaså®é™…å°ºå¯¸:', canvas.width, 'x', canvas.height);
            console.log('Canvasæ˜¾ç¤ºæ ·å¼:', canvas.style.width, 'x', canvas.style.height);
            
            // é‡ç½®Canvasä¸Šä¸‹æ–‡
            const ctx = canvas.getContext('2d');
            if (ctx) {
                ctx.save();
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                // ç»˜åˆ¶ä¸€ä¸ªæµ‹è¯•çŸ©å½¢ï¼Œç¡®ä¿Canvaså¯è§
                ctx.fillStyle = 'rgba(240, 240, 240, 0.5)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.restore();
                console.log('Canvasæµ‹è¯•çŸ©å½¢ç»˜åˆ¶æˆåŠŸ');
            }
            
            // æ£€æŸ¥Chart.jsæ˜¯å¦å·²æ­£ç¡®åŠ è½½
            if (typeof Chart === 'undefined') {
                console.error('Chart.jsæœªæ­£ç¡®åŠ è½½');
                // å°è¯•åŠ è½½å¤šä¸ªå¤‡ç”¨CDN
                const cdnUrls = [
                    'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js',
                    'https://unpkg.com/chart.js@4.4.0/dist/chart.umd.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js'
                ];
                
                let currentCdnIndex = 0;
                
                const tryNextCdn = () => {
                    if (currentCdnIndex >= cdnUrls.length) {
                        console.error('æ‰€æœ‰Chart.js CDNåŠ è½½å¤±è´¥');
                        showStaticTemperatureTable(cities, temperatures);
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = cdnUrls[currentCdnIndex];
                    script.onload = function() {
                        console.log('Chart.js CDNåŠ è½½æˆåŠŸ:', cdnUrls[currentCdnIndex]);
                        // é‡æ–°å°è¯•ç»˜åˆ¶å›¾è¡¨
                        drawTemperatureChart(cities, temperatures);
                    };
                    script.onerror = function() {
                        console.error('Chart.js CDNåŠ è½½å¤±è´¥:', cdnUrls[currentCdnIndex]);
                        currentCdnIndex++;
                        tryNextCdn();
                    };
                    document.head.appendChild(script);
                };
                
                tryNextCdn();
                return;
            }
            
            // é”€æ¯å·²å­˜åœ¨çš„å›¾è¡¨å®ä¾‹
            if (window.temperatureChart && typeof window.temperatureChart.destroy === 'function') {
                try {
                    window.temperatureChart.destroy();
                    window.temperatureChart = null;
                    console.log('å·²é”€æ¯æ—§å›¾è¡¨å®ä¾‹');
                } catch (error) {
                    console.error('é”€æ¯å›¾è¡¨å¤±è´¥:', error);
                    // å¦‚æœé”€æ¯å¤±è´¥ï¼Œå°è¯•é‡æ–°åˆ›å»ºcanvas
                    const newCanvas = document.createElement('canvas');
                    newCanvas.id = 'temperatureChart';
                    newCanvas.width = canvas.width;
                    newCanvas.height = canvas.height;
                    canvas.parentNode.replaceChild(newCanvas, canvas);
                    // é‡æ–°è·å–canvaså¼•ç”¨
                    const updatedCanvas = document.getElementById('temperatureChart');
                    // ä½¿ç”¨æ–°çš„canvaså¼•ç”¨ç»§ç»­
                    if (updatedCanvas) {
                        console.log('å·²é‡æ–°åˆ›å»ºcanvaså…ƒç´ ');
                        // é‡æ–°è®¾ç½®canvaså¼•ç”¨
                        canvas = updatedCanvas;
                    }
                }
            } else {
                window.temperatureChart = null;
                console.log('æ— æ—§å›¾è¡¨å®ä¾‹éœ€è¦é”€æ¯');
            }
            
            try {
                // å¤„ç†æ•°æ®ï¼šç¡®ä¿æ‰€æœ‰æ¸©åº¦éƒ½æ˜¯æ•°å­—ç±»å‹
                const processedTemperatures = temperatures.map((temp, index) => {
                    if (temp === null || temp === undefined) {
                        console.warn(`åŸå¸‚ ${cities[index]} æ¸©åº¦æ•°æ®ä¸ºnullæˆ–undefined`);
                        return 0;
                    }
                    
                    // å¦‚æœæ¸©åº¦æ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æ
                    if (typeof temp === 'string') {
                        // ç§»é™¤æ¸©åº¦ç¬¦å·å’Œç©ºæ ¼
                        const cleanTemp = temp.replace(/[Â°Câ„ƒ ]/g, '');
                        const parsedTemp = parseFloat(cleanTemp);
                        if (isNaN(parsedTemp)) {
                            console.warn(`åŸå¸‚ ${cities[index]} æ¸©åº¦æ•°æ®æ ¼å¼é”™è¯¯: ${temp}`);
                            return 0;
                        }
                        return parsedTemp;
                    }
                    
                    // å¦‚æœæ¸©åº¦æ˜¯æ•°å­—ï¼Œç›´æ¥ä½¿ç”¨
                    if (typeof temp === 'number') {
                        if (isNaN(temp)) {
                            console.warn(`åŸå¸‚ ${cities[index]} æ¸©åº¦æ•°æ®ä¸ºNaN`);
                            return 0;
                        }
                        return temp;
                    }
                    
                    // å…¶ä»–æƒ…å†µè¿”å›0
                    console.warn(`åŸå¸‚ ${cities[index]} æ¸©åº¦æ•°æ®ç±»å‹é”™è¯¯: ${typeof temp}`);
                    return 0;
                });
                
                // è®¡ç®—æ¸©åº¦èŒƒå›´
                const validTemperatures = processedTemperatures.filter(temp => temp !== 0);
                const minTemp = validTemperatures.length > 0 ? Math.floor(Math.min(...validTemperatures) - 5) : 0;
                const maxTemp = validTemperatures.length > 0 ? Math.ceil(Math.max(...validTemperatures) + 5) : 30;
                
                console.log('å¤„ç†åçš„æ¸©åº¦æ•°æ®:', processedTemperatures);
                console.log('æ¸©åº¦èŒƒå›´:', minTemp, 'åˆ°', maxTemp);
                
                // ä½¿ç”¨æ›´ç¨³å®šçš„å›¾è¡¨é…ç½®
                const ctx = canvas.getContext('2d');
                
                // ç¡®ä¿Canvasä¸Šä¸‹æ–‡æœ‰æ•ˆ
                if (!ctx) {
                    console.error('æ— æ³•è·å–Canvasä¸Šä¸‹æ–‡');
                    showStaticTemperatureTable(cities, temperatures);
                    return;
                }
                
                // é‡ç½®Canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // åˆ›å»ºæ–°çš„å›¾è¡¨å®ä¾‹ï¼ˆä½¿ç”¨æœ€ç¨³å®šçš„é…ç½®ï¼‰
                console.log('å¼€å§‹åˆ›å»ºChartå®ä¾‹');
                console.log('å¤„ç†åçš„æ¸©åº¦æ•°æ®:', processedTemperatures);
                console.log('æ¸©åº¦èŒƒå›´:', minTemp, 'åˆ°', maxTemp);
                
                // ä½¿ç”¨ç®€åŒ–çš„å›¾è¡¨é…ç½®ï¼Œé¿å…å¯èƒ½çš„å…¼å®¹æ€§é—®é¢˜
                window.temperatureChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: cities,
                        datasets: [{
                            label: 'å½“å‰æ¸©åº¦ (Â°C)',
                            data: processedTemperatures,
                            backgroundColor: 'rgba(54, 162, 235, 0.8)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                            // ç§»é™¤å¯èƒ½æœ‰å…¼å®¹æ€§é—®é¢˜çš„é…ç½®é¡¹
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: minTemp,
                                max: maxTemp,
                                title: {
                                    display: true,
                                    text: 'æ¸©åº¦ (Â°C)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value + 'Â°C';
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'åŸå¸‚'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 30
                                },
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'çƒ­é—¨åŸå¸‚æ¸©åº¦å®æ—¶å¯¹æ¯”'
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                enabled: true
                            }
                        },
                        animation: {
                            duration: 0 // ç¦ç”¨åŠ¨ç”»ä»¥æé«˜ç¨³å®šæ€§
                        }
                    }
                });
                
                console.log('å›¾è¡¨å®ä¾‹åˆ›å»ºæˆåŠŸ');
                console.log('Chartå®ä¾‹:', window.temperatureChart);
                console.log('Chartå®ä¾‹çŠ¶æ€:', window.temperatureChart.canvas.style.display);
                
                // å¼ºåˆ¶é‡ç»˜å›¾è¡¨
                window.temperatureChart.update('none'); // ä½¿ç”¨'none'åŠ¨ç”»æ¨¡å¼
                console.log('å›¾è¡¨æ›´æ–°å®Œæˆ');
                
                // åªæ·»åŠ ä¸€æ¬¡çª—å£å¤§å°å˜åŒ–äº‹ä»¶ç›‘å¬
                if (!window.resizeListenerAdded) {
                    window.addEventListener('resize', function() {
                        if (window.temperatureChart) {
                            console.log('çª—å£å¤§å°å˜åŒ–ï¼Œè°ƒæ•´å›¾è¡¨å°ºå¯¸');
                            window.temperatureChart.resize();
                        }
                    });
                    window.resizeListenerAdded = true;
                }
                
            } catch (error) {
                console.error('ç»˜åˆ¶å›¾è¡¨å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.stack);
                // å¦‚æœå›¾è¡¨ç»˜åˆ¶å¤±è´¥ï¼Œæ˜¾ç¤ºé™æ€è¡¨æ ¼
                showStaticTemperatureTable(cities, temperatures);
            }
        }
        
        // æ˜¾ç¤ºé™æ€æ¸©åº¦å¯¹æ¯”è¡¨æ ¼ï¼ˆä½œä¸ºChart.jsçš„å¤‡é€‰æ–¹æ¡ˆï¼‰
        function showStaticTemperatureTable(cities, temperatures) {
            console.log('æ˜¾ç¤ºé™æ€æ¸©åº¦å¯¹æ¯”è¡¨æ ¼');
            const chartContainer = document.getElementById('chartContainer');
            const canvas = document.getElementById('temperatureChart');
            
            if (canvas) {
                // éšè—canvaså…ƒç´ 
                canvas.style.display = 'none';
            }
            
            // åˆ›å»ºè¡¨æ ¼å…ƒç´ 
            let tableHTML = `
                <table class="table table-striped">
                    <thead class="table-primary">
                        <tr>
                            <th scope="col">åŸå¸‚</th>
                            <th scope="col">å½“å‰æ¸©åº¦ (Â°C)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // æ·»åŠ è¡¨æ ¼å†…å®¹
            cities.forEach((city, index) => {
                const temp = temperatures[index] !== null ? temperatures[index] : 'æ— æ•°æ®';
                tableHTML += `
                    <tr>
                        <td>${city}</td>
                        <td>${temp}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            // æ·»åŠ è¡¨æ ¼åˆ°å›¾è¡¨å®¹å™¨
            const tableDiv = document.createElement('div');
            tableDiv.innerHTML = tableHTML;
            tableDiv.id = 'temperatureTable';
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¡¨æ ¼å…ƒç´ ï¼Œå¦‚æœå­˜åœ¨åˆ™æ›¿æ¢
            const existingTable = chartContainer.querySelector('#temperatureTable');
            if (existingTable) {
                existingTable.remove();
            }
            
            chartContainer.appendChild(tableDiv);
        }
        
        // æŸ¥è¯¢å†å²å¤©æ°”æ•°æ®
        function searchHistoricalWeather() {
            const city = document.getElementById('historicalCity').value.trim();
            const date = document.getElementById('historicalDate').value;
            
            if (!city) {
                showError('è¯·è¾“å…¥åŸå¸‚åç§°');
                return;
            }
            
            if (!date) {
                showError('è¯·é€‰æ‹©æŸ¥è¯¢æ—¥æœŸ');
                return;
            }
            
            // éšè—ä¹‹å‰çš„ç»“æœå’Œé”™è¯¯
            hideError();
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const historicalSearchBtn = document.getElementById('historicalSearch');
            const originalText = historicalSearchBtn.textContent;
            historicalSearchBtn.disabled = true;
            historicalSearchBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> æŸ¥è¯¢ä¸­...';
            
            // å‘é€APIè¯·æ±‚
            fetch(`/historical?city=${encodeURIComponent(city)}&date=${encodeURIComponent(date)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                    } else {
                        displayHistoricalResult(data);
                    }
                })
                .catch(error => {
                    console.error('æŸ¥è¯¢å†å²å¤©æ°”å¤±è´¥:', error);
                    showError('æŸ¥è¯¢å†å²å¤©æ°”å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                })
                .finally(() => {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    historicalSearchBtn.disabled = false;
                    historicalSearchBtn.textContent = originalText;
                });
        }
        
        // æ˜¾ç¤ºå†å²å¤©æ°”ç»“æœ
        function displayHistoricalResult(data) {
            const resultContainer = document.getElementById('historicalResult');
            const cityResult = document.getElementById('historicalCityResult');
            const dataTable = document.getElementById('historicalDataTable');
            
            // è®¾ç½®åŸå¸‚åç§°
            cityResult.innerHTML = `${data.city} - ${data.date} å†å²å¤©æ°”æ•°æ®`;
            
            // æ„å»ºè¡¨æ ¼
            let tableHtml = '<table class="table table-striped table-bordered">';
            tableHtml += '<thead><tr><th>æ—¶é—´</th><th>æ¸©åº¦</th><th>æ¹¿åº¦</th><th>å¤©æ°”çŠ¶å†µ</th><th>é£åŠ›</th><th>é£å‘</th></tr></thead>';
            tableHtml += '<tbody>';
            
            if (data.data && data.data.length > 0) {
                data.data.forEach(item => {
                    const hour = item.record_hour < 10 ? `0${item.record_hour}` : item.record_hour;
                    tableHtml += `<tr>`;
                    tableHtml += `<td>${hour}:00</td>`;
                    tableHtml += `<td>${item.temperature}</td>`;
                    tableHtml += `<td>${item.humidity}</td>`;
                    tableHtml += `<td>${item.weather}</td>`;
                    tableHtml += `<td>${item.wind}</td>`;
                    tableHtml += `<td>${item.wind_dir}</td>`;
                    tableHtml += `</tr>`;
                });
            } else {
                tableHtml += '<tr><td colspan="6" class="text-center">æœªæ‰¾åˆ°è¯¥æ—¥çš„å†å²å¤©æ°”æ•°æ®</td></tr>';
            }
            
            tableHtml += '</tbody></table>';
            dataTable.innerHTML = tableHtml;
            
            // æ˜¾ç¤ºç»“æœ
            resultContainer.style.display = 'block';
        }
    </script>
</body>
</html>